# M8-T2 åç«¯ä»£ç æ¶æ„å…¨é‡å®¡æ ¸æŠ¥å‘Š

**å®¡æ ¸æ—¶é—´**: 2026-02-28 15:00 - 18:40  
**å®¡æ ¸äºº**: Code Agent  
**é¡¹ç›®**: MusicPilot  
**é‡Œç¨‹ç¢‘**: M8 - ä»£ç ä¸æ¶æ„å®¡æŸ¥  
**ä»»åŠ¡**: M8-T2 åç«¯ä»£ç æ¶æ„å…¨é‡å®¡æ ¸  

---

## ğŸ“‹ å®¡æ ¸èŒƒå›´

æœ¬æ¬¡å®¡æ ¸è¦†ç›–ä»¥ä¸‹æ¨¡å—ï¼š
1. Core æ ¸å¿ƒæ¨¡å— (chain, module, plugin, event, config, cache, context, log)
2. Database æ•°æ®åº“æ¨¡å— (db_manager, models, operations)
3. Chain ä¸šåŠ¡é“¾æ¨¡å— (æ‰€æœ‰ Chain å­ç±»)
4. Modules åŠŸèƒ½æ¨¡å— (downloader, indexer, metadata, sites)
5. API è·¯ç”±æ¨¡å— (endpoints, apiv1)
6. Schemas æ•°æ®æ¨¡å‹
7. Utils å·¥å…·æ¨¡å—

---

## ğŸš¨ ä¸¥é‡é—®é¢˜æ±‡æ€» (Critical Issues)

### 1. Python ç‰ˆæœ¬ä¸å…¼å®¹ - ğŸ”´ è‡´å‘½

| é¡¹ç›® | è¯¦æƒ… |
|------|------|
| **é—®é¢˜** | ä»£ç ä½¿ç”¨ Python 3.12+ æ³›å‹ç±»è¯­æ³•ï¼Œä½†å½“å‰ç¯å¢ƒä¸º Python 3.11 |
| **å½±å“** | åº”ç”¨å®Œå…¨æ— æ³•å¯åŠ¨ï¼Œæ•°æ®åº“æ¨¡å—å’Œå“åº”æ¨¡å‹æ— æ³•å¯¼å…¥ |
| **ä½ç½®** | `app/db/__init__.py:129`, `app/schemas/response.py:13` |
| **é”™è¯¯ä»£ç ** | `class OperBase[ModelType: Base]:` |
| **ä¿®å¤æ–¹æ¡ˆ** | é™çº§ä¸ºä¼ ç»Ÿ TypeVar + Generic è¯­æ³•ï¼Œæˆ–å‡çº§ Python åˆ° 3.12+ |

**å…·ä½“æ–‡ä»¶**:
```python
# app/db/__init__.py:129 (Python 3.12+ è¯­æ³•)
class OperBase[ModelType: Base]:
    ...

# app/schemas/response.py:13 (Python 3.12+ è¯­æ³•)
class ResponseModel[T](BaseModel):
    ...
```

### 2. ModuleManager ç¼ºå°‘å…³é”®æ–¹æ³• - ğŸ”´ è‡´å‘½

| é¡¹ç›® | è¯¦æƒ… |
|------|------|
| **é—®é¢˜** | ModuleManager æœªå®ç° `run_module` æ–¹æ³• |
| **å½±å“** | ChainBase.run_module() è°ƒç”¨ä¼šæŠ›å‡º AttributeError |
| **ä½ç½®** | `app/core/module.py` |
| **è°ƒç”¨æ–¹** | `app/core/chain.py:65` - `self.module_manager.run_module(...)` |
| **ä¿®å¤æ–¹æ¡ˆ** | åœ¨ ModuleManager ä¸­æ·»åŠ  run_module æ–¹æ³• |

**éœ€è¦æ·»åŠ çš„æ–¹æ³•**:
```python
async def run_module(self, module_name: str, method: str, *args, **kwargs):
    """è¿è¡ŒæŒ‡å®šæ¨¡å—çš„æ–¹æ³•"""
    module = self.get_module(module_name)
    if not module:
        raise ValueError(f"Module {module_name} not found")
    func = getattr(module, method, None)
    if not func:
        raise AttributeError(f"Module {module_name} has no method {method}")
    result = func(*args, **kwargs)
    if hasattr(result, '__await__'):
        return await result
    return result
```

### 3. PluginManager åˆå§‹åŒ–å‚æ•°ä¸åŒ¹é… - ğŸ”´ è‡´å‘½

| é¡¹ç›® | è¯¦æƒ… |
|------|------|
| **é—®é¢˜** | PluginManager.__init__ éœ€è¦ event_manager å‚æ•°ï¼Œä½† ChainBase ä¸ä¼  |
| **å½±å“** | ChainBase åˆå§‹åŒ– PluginManager æ—¶ä¼šæŠ›å‡º TypeError |
| **ä½ç½®** | `app/core/plugin.py:97`, `app/core/chain.py:42` |
| **ä¿®å¤æ–¹æ¡ˆ** | è®© PluginManager çš„ event_manager å‚æ•°å¯é€‰ï¼Œæˆ–ä½¿ç”¨å…¨å±€ event_bus |

**å½“å‰ä»£ç **:
```python
# app/core/plugin.py:97
class PluginManager:
    def __init__(self, event_manager: EventManager):  # å¿…éœ€å‚æ•°
        ...

# app/core/chain.py:42
self.plugin_manager = plugin_manager or PluginManager()  # æ²¡æœ‰ä¼ å‚æ•°ï¼
```

### 4. ä¾èµ–ç¼ºå¤± - ğŸ”´ é˜»å¡

| é¡¹ç›® | è¯¦æƒ… |
|------|------|
| **é—®é¢˜** | ç¼ºå°‘ mutagen ç­‰ä¾èµ–åŒ… |
| **å½±å“** | å¤šä¸ªæ¨¡å—æ— æ³•å¯¼å…¥ |
| **ä¿®å¤æ–¹æ¡ˆ** | å®‰è£…é¡¹ç›®ä¾èµ–ï¼š`pip install -r requirements.txt` |

---

## âš ï¸ ä¸­ç­‰é—®é¢˜ (Medium Issues)

### 5. æ½œåœ¨çš„å¾ªç¯å¯¼å…¥é£é™©

| é¡¹ç›® | è¯¦æƒ… |
|------|------|
| **é—®é¢˜** | app/chain/__init__.py ä» app.core.chain å¯¼å…¥ ChainBaseï¼ŒåŒæ—¶å„ä¸ª chain æ–‡ä»¶å¯èƒ½åå‘å¯¼å…¥ |
| **ä½ç½®** | `app/chain/__init__.py` |
| **å½“å‰çŠ¶æ€** | æš‚æœªè§¦å‘å¾ªç¯å¯¼å…¥ï¼Œä½†ç»“æ„è„†å¼± |
| **å»ºè®®** | è€ƒè™‘å»¶è¿Ÿå¯¼å…¥æˆ–é‡æ„å¯¼å…¥é¡ºåº |

### 6. ç±»å‹æ³¨è§£ä¸ä¸€è‡´

éƒ¨åˆ†æ–‡ä»¶ä½¿ç”¨ `list[str]` (Python 3.9+) è€Œå¦ä¸€äº›ä½¿ç”¨ `List[str]` (typing æ¨¡å—)ï¼Œå»ºè®®ç»Ÿä¸€ã€‚

---

## âœ… æ­£å¸¸æ¨¡å—æ¸…å•

ä»¥ä¸‹æ¨¡å—ç»æ£€æŸ¥æ— ä¸¥é‡é—®é¢˜ï¼š

| æ¨¡å— | çŠ¶æ€ | å¤‡æ³¨ |
|------|------|------|
| app/core/event.py | âœ… | EventManager å®ç°å®Œæ•´ |
| app/core/config.py | âœ… | Settings é…ç½®æ­£ç¡® |
| app/core/cache.py | âœ… | Cache æ¨¡å—æ­£å¸¸ |
| app/core/context.py | âœ… | Context ç®¡ç†æ­£å¸¸ |
| app/core/log.py | âœ… | æ—¥å¿—ç³»ç»Ÿæ­£å¸¸ |
| app/api/endpoints/*.py | âœ… | æ‰€æœ‰ç«¯ç‚¹æ–‡ä»¶è¯­æ³•æ­£ç¡® |
| app/chain/*.py | âœ… | æ‰€æœ‰ Chain æ–‡ä»¶è¯­æ³•æ­£ç¡®ï¼ˆä½†å¯èƒ½æ— æ³•è¿è¡Œï¼‰ |
| app/modules/*.py | âœ… | æ¨¡å—æ–‡ä»¶è¯­æ³•æ­£ç¡® |

---

## ğŸ“Š å®¡æ ¸ç»Ÿè®¡

| ç±»åˆ« | æ•°é‡ |
|------|------|
| æ€»æ–‡ä»¶æ•° | 91 |
| è¯­æ³•æ­£ç¡®æ–‡ä»¶ | 89 (97.8%) |
| è¯­æ³•é”™è¯¯æ–‡ä»¶ | 2 (2.2%) |
| è‡´å‘½é—®é¢˜ | 4 |
| ä¸­ç­‰é—®é¢˜ | 2 |
| å¯æ­£å¸¸è¿è¡Œæ¨¡å— | ~10% (å— Python ç‰ˆæœ¬å’Œæ–¹æ³•ç¼ºå¤±å½±å“) |

---

## ğŸ”§ ä¿®å¤ä¼˜å…ˆçº§

### P0 - ç«‹å³ä¿®å¤ (é˜»å¡å‘å¸ƒ)
1. **Python ç‰ˆæœ¬å…¼å®¹æ€§** - é™çº§æ³›å‹ç±»è¯­æ³•åˆ° 3.11 å…¼å®¹
2. **ModuleManager.run_module** - æ·»åŠ ç¼ºå¤±æ–¹æ³•
3. **PluginManager åˆå§‹åŒ–** - ä¿®å¤å‚æ•°ä¸åŒ¹é…

### P1 - å°½å¿«ä¿®å¤
4. **ä¾èµ–å®‰è£…** - ç¡®ä¿æ‰€æœ‰ä¾èµ–å¯å®‰è£…
5. **å†’çƒŸæµ‹è¯•** - åˆ›å»ºè‡ªåŠ¨åŒ–æµ‹è¯•éªŒè¯åº”ç”¨å¯å¯åŠ¨

### P2 - åç»­ä¼˜åŒ–
6. **å¾ªç¯å¯¼å…¥é˜²æŠ¤** - é‡æ„å¯¼å…¥ç»“æ„
7. **ç±»å‹æ³¨è§£ç»Ÿä¸€** - ç»Ÿä¸€ typing é£æ ¼

---

## ğŸ’¡ ç»éªŒæ•™è®­

### æœ¬æ¬¡å®¡æ ¸å‘ç°çš„é—®é¢˜
1. **M8 åˆæ¬¡å®¡æ ¸ä¸¥é‡å¤±èŒ** - åªæ£€æŸ¥äº†æ–‡ä»¶å­˜åœ¨æ€§ï¼ŒæœªéªŒè¯å®é™…å¯è¿è¡Œæ€§
2. **CI æ£€æŸ¥ä¸è¶³** - Ruff lint é€šè¿‡ä¸ä»£è¡¨ä»£ç èƒ½è¿è¡Œ
3. **Python ç‰ˆæœ¬è¦æ±‚ä¸æ˜ç¡®** - pyproject.toml è¦æ±‚ 3.12+ ä½†æœªåœ¨ CI ä¸­å¼ºåˆ¶æ‰§è¡Œ
4. **ç¼ºå°‘å†’çƒŸæµ‹è¯•** - æ²¡æœ‰æœ€åŸºæœ¬çš„"åº”ç”¨èƒ½å¦å¯åŠ¨"æµ‹è¯•

### æ”¹è¿›æªæ–½
1. æ·»åŠ  `smoke_test.py` éªŒè¯åº”ç”¨å¯å¯åŠ¨
2. CI ä¸­æ·»åŠ  Python ç‰ˆæœ¬æ£€æŸ¥
3. ä»»ä½•"æ¶æ„å®Œæˆ"å£°æ˜å¿…é¡»é™„å¸¦å¯è¿è¡Œè¯æ˜
4. å®šæœŸè¿›è¡Œå…¨é‡å®¡æ ¸ï¼Œè€Œéä»…æ£€æŸ¥æ–‡ä»¶å­˜åœ¨

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **åˆ›å»ºä¿®å¤åˆ†æ”¯** - åŸºäº main åˆ›å»º fix/architecture-compatibility
2. **ä¿®å¤ Python 3.11 å…¼å®¹æ€§** - ä¿®æ”¹ db/__init__.py å’Œ schemas/response.py
3. **ä¿®å¤ ModuleManager** - æ·»åŠ  run_module æ–¹æ³•
4. **ä¿®å¤ PluginManager** - ä½¿ event_manager å‚æ•°å¯é€‰
5. **åˆ›å»ºå†’çƒŸæµ‹è¯•** - éªŒè¯æ‰€æœ‰æ ¸å¿ƒç»„ä»¶å¯å¯¼å…¥å’Œå®ä¾‹åŒ–
6. **æäº¤ PR å¹¶ç­‰å¾… CI é€šè¿‡**
7. **åˆå¹¶åé‡æ–°è¿›è¡ŒåŠŸèƒ½æµ‹è¯•**

---

**å®¡æ ¸ç»“è®º**: MusicPilot åç«¯æ¶æ„å­˜åœ¨ä¸¥é‡çš„å¯è¿è¡Œæ€§é—®é¢˜ï¼Œä¸»è¦æ˜¯ Python ç‰ˆæœ¬ä¸å…¼å®¹å’Œå…³é”®æ–¹æ³•ç¼ºå¤±ã€‚è¿™äº›é—®é¢˜å¿…é¡»åœ¨ç»§ç»­å¼€å‘å‰ä¿®å¤ã€‚

**å®¡æ ¸çŠ¶æ€**: å®Œæˆ  
**å»ºè®®**: æš‚åœ M9 æµ‹è¯•ä»»åŠ¡ï¼Œä¼˜å…ˆä¿®å¤ M8-T2 å‘ç°çš„æ¶æ„é—®é¢˜
